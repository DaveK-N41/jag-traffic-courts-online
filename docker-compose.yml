version: "3.8"

services:
  # #############################################################################################
  # ###                                 TrafficCourt BACKEND                                  ###
  # #############################################################################################

  # ---------------------------------------------------------------------------------------------
  # Citizen API
  # ---------------------------------------------------------------------------------------------
  citizen-api:
    container_name: citizen-api
    build:
      context: ./src/backend/TrafficCourts
      dockerfile: ./Citizen.Service/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      FORMRECOGNIZER__APIKEY: ${FORMRECOGNIZER__APIKEY:-}
      FORMRECOGNIZER__ENDPOINT: ${FORMRECOGNIZER__ENDPOINT:-}
      #SPLUNK__URL: http://splunk:8088/
      #SPLUNK__TOKEN: ${SPLUNK__TOKEN:-}
      MASSTRANSIT__TRANSPORT: InMemory
      RABBITMQ__HOST: rabbitmq
      RABBITMQ__PORT: 5672
      RABBITMQ__USERNAME: ${RABBITMQ__USERNAME:-guest}
      RABBITMQ__PASSWORD: ${RABBITMQ__PASSWORD:-}
      TICKETSEARCHAPI__BASEURL: http://ticket-search:8080/
      TICKETSEARCHCLIENT__ADDRESS: ${TICKETSEARCHCLIENT__ADDRESS:-http://localhost/}
    ports:
      - "5000:8080"
    restart: always
    depends_on: [rabbitmq, ticket-search, seq]
    networks:
      - traffic-court-net
    volumes:
      # mount the current users usersecrets folder
      - "${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro"

  # ---------------------------------------------------------------------------------------------
  # Ticket Search API
  # ---------------------------------------------------------------------------------------------
  ticket-search:
    container_name: ticket-search
    build:
      context: ./src/backend/TrafficCourts
      dockerfile: ./TrafficCourts.Ticket.Search.Service/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      #SPLUNK_COLLECTOR_URL: http://splunk:8088/
      #SPLUNK_TOKEN: 176FCEBF-4CF5-4EDF-91BC-703796522D20
      OAUTH__OAUTHURL: ${OAUTH__OAUTHURL}
      OAUTH__RESOURCEURL: ${OAUTH__RESOURCEURL}
      OAUTH__CLIENTID: ${OAUTH__CLIENTID}
      OAUTH__SECRET: ${OAUTH__SECRET}
      RSI__BASEADDRESS: ${RSI__BASEADDRESS}
      RSI__OPERATIONMODE:
    ports:
      - "5100:8080"
    restart: always
    #depends_on: [splunk]
    networks:
      - traffic-court-net
    volumes:
      # mount the current users usersecrets folder
      - "${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro"

  # #############################################################################################
  # ###                                 TrafficCourt FRONTEND                                 ###
  # #############################################################################################
  citizen-portal:
    container_name: citizen-portal
    build:
      context: ./src/frontend/citizen-portal
    restart: always
    ports:
      - "8080:8080"
    ## following is used for testing nginx.conf locally. No need to build the citizen-portal every
    ## time we change the nginx.conf, start a shell in the container and run 'service nginx reload' or '/etc/init.d/nginx reload'
    #volumes:
    #  - ./src/frontend/citizen-portal/nginx.conf:/opt/app-root/etc/nginx.default.d/default.conf
    depends_on: [citizen-api]
    networks:
      - traffic-court-net

  #############################################################################################
  ###                           RABBITMQ                                                    ###
  #############################################################################################
  rabbitmq:
    image: rabbitmq:3.9.12-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - data-rabbit:/var/lib/rabbitmq/mnesia/rabbit@app-rabbitmq:cached
    restart: always
    networks:
      - traffic-court-net

  #############################################################################################
  ###                           Seq                                                         ###
  #############################################################################################
  seq:
    image: datalust/seq:latest
    ports:
      - 5341:80
    environment:
      ACCEPT_EULA: Y
    restart: unless-stopped

networks:
  traffic-court-net:
    driver: "bridge"

volumes:
  data-rabbit:
  data-redis:
